<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.macula.cloud.admin.mapper.SysUserMapper">

    <resultMap id="resultVoMap" type="org.macula.cloud.admin.entity.vo.admin.UserVO">
        <id property="id" column="id"/>
        <result property="userName" column="user_name"/>
        <result property="fullName" column="full_name"/>
        <result property="nickName" column="nick_name"/>
        <result property="code" column="code"/>
        <result property="sex" column="sex"/>
        <result property="birthday" column="birthday"/>
        <result property="grade" column="grade"/>
        <result property="position" column="position"/>
        <result property="phone" column="phone"/>
        <result property="mail" column="mail"/>
        <result property="imageUrl" column="image_url"/>
        <result property="isEnabled" column="is_enabled"/>
        <result property="source" column="source"/>
        <result property="isDeleted" column="is_deleted"/>
        <result property="comments" column="comments"/>
        <result property="idCard" column="id_card"/>

        <collection property="department" ofType="org.macula.cloud.admin.entity.pojo.admin.SysDepartment">
            <result property="id" column="department_id"/>
            <result property="name" column="department_name"/>
        </collection>
        <collection property="roles" ofType="org.macula.cloud.admin.entity.pojo.privilege.Role"
                    javaType="java.util.ArrayList">
            <result property="id" column="role_id"/>
            <result property="name" column="role_name"/>
        </collection>
        <collection property="company" ofType="org.macula.cloud.admin.entity.pojo.admin.SysCompany">
            <result property="id" column="sc_company_id"/>
            <result property="businessId" column="business_id"/>
            <result property="shortName" column="company_name"/>
        </collection>
    </resultMap>

    <resultMap id="resultVoMap1"  extends="resultVoMap" type="org.macula.cloud.admin.entity.vo.admin.UserVO">
        <result property="password" column="password"/>
    </resultMap>


    <resultMap id="resultUserMap" type="org.macula.cloud.admin.entity.pojo.admin.SysUser">
        <id property="id" column="id"/>
        <result property="userName" column="user_name"/>
        <result property="fullName" column="full_name"/>
        <result property="nickName" column="nick_name"/>
        <result property="code" column="code"/>
        <result property="sex" column="sex"/>
        <result property="birthday" column="birthday"/>
        <result property="grade" column="grade"/>
        <result property="position" column="position"/>
        <result property="departmentId" column="department_id"/>
        <result property="departmentIdStr" column="department_id_str"/>
        <result property="phone" column="phone"/>
        <result property="mail" column="mail"/>
        <result property="imageUrl" column="image_url"/>
        <result property="isEnabled" column="is_enabled"/>
        <result property="source" column="source"/>
        <result property="isDeleted" column="is_deleted"/>
        <result property="comments" column="comments"/>
        <result property="companyId" column="company_id"/>
        <result property="idCard" column="id_card"/>

        <collection property="roleIds" ofType="java.lang.Long" javaType="java.util.ArrayList">
            <result property="id" column="role_id"/>
        </collection>
    </resultMap>

    <select id="searchUserPage" resultMap="resultVoMap">
        SELECT * FROM(SELECT @rownum:=@rownum+1 rownum,IF(@userid=u.id,@rank,@rank:=@rank+1) AS rn,@userid:=u.id AS
        uid,u.*
        FROM (
        SELECT su.*,
        sr.id AS role_id,
        sr.name AS role_name,
        sd.name AS department_name,
        sc.id AS sc_company_id,
        sc.business_id AS business_id,
        sc.short_name AS company_name
        FROM sys_user su
        LEFT JOIN sys_user_role sur ON su.id = sur.user_id
        LEFT JOIN sys_role sr ON sr.id = sur.role_id
        LEFT JOIN sys_department sd ON sd.business_id = su.department_id
        LEFT JOIN sys_company sc ON sc.business_id = su.company_id
        WHERE 1=1
        AND su.is_deleted = 0
        <if test="departmentId != null and departmentId !='' ">
            AND su.department_id in (select d.id from dep_topology d,(select * from dep_topology d where d.id =
            #{departmentId}) d1
            where case d1.level when 1 then d.level1id=d1.id when 2 then d.level2id=d1.id when 3 then d.level3id=d1.id
            when 4 then d.level4id=d1.id when 5 then d.level5id=d1.id when 6 then d.level6id=d1.id end)
        </if>

        <if test="companyId != null and companyId !='' ">
            AND su.company_id=#{companyId}
        </if>

        <if test="user.userName != null and user.userName !='' ">
            AND su.user_name like CONCAT('%', #{user.userName},'%')
        </if>
        <if test="user.fullName != null and user.fullName !='' ">
            AND su.full_name like CONCAT('%', #{user.fullName},'%')
        </if>
        <if test="user.nickName != null and user.nickName !='' ">
            AND su.nick_name like CONCAT('%', #{user.nickName},'%')
        </if>
        <if test="user.phone != null and user.phone !='' ">
            AND su.phone like CONCAT('%', #{user.phone},'%')
        </if>
        <if test="user.id != null and user.createBy != null ">
            AND (su.id=#{user.id} or su.create_by=#{user.createBy})
        </if>

        <if test="keyword != null and keyword !='' ">
            AND (su.user_name like CONCAT('%', #{keyword},'%')
            or su.full_name like CONCAT('%', #{keyword},'%')
            or su.nick_name like CONCAT('%', #{keyword},'%')
            or su.phone like CONCAT('%', #{keyword},'%'))
        </if>

        ORDER BY su.id DESC) u,
        (SELECT @rownum:=0,@userid:=NULL,@rank:=0)b)res
        WHERE 1=1
        AND res.rn <![CDATA[ > ]]> #{offset} AND res.rn <![CDATA[ <= ]]> #{pageEnd}
    </select>

    <select id="searchUserPageCount" resultType="Integer">
        SELECT count(1) FROM sys_user su
        WHERE 1=1
        AND su.is_deleted = 0
        <if test="departmentId != null and departmentId !='' ">
            AND su.department_id in (select d.id from dep_topology d,(select * from dep_topology d where d.id =
            #{departmentId}) d1
            where case d1.level when 1 then d.level1id=d1.id when 2 then d.level2id=d1.id when 3 then d.level3id=d1.id
            when 4 then d.level4id=d1.id when 5 then d.level5id=d1.id when 6 then d.level6id=d1.id end)
        </if>

        <if test="companyId != null and companyId !='' ">
            AND su.company_id=#{companyId}
        </if>

        <if test="user.userName != null and user.userName !='' ">
            AND su.user_name like CONCAT('%', #{user.userName},'%')
        </if>
        <if test="user.fullName != null and user.fullName !='' ">
            AND su.full_name like CONCAT('%', #{user.fullName},'%')
        </if>
        <if test="user.nickName != null and user.nickName !='' ">
            AND su.nick_name like CONCAT('%', #{user.nickName},'%')
        </if>
        <if test="user.phone != null and user.phone !='' ">
            AND su.phone like CONCAT('%', #{user.phone},'%')
        </if>
        <if test="user.id != null and user.createBy != null ">
            AND (su.id=#{user.id} or su.create_by=#{user.createBy})
        </if>

        <if test="keyword != null and keyword !='' ">
            AND (su.user_name like CONCAT('%', #{keyword},'%')
            or su.full_name like CONCAT('%', #{keyword},'%')
            or su.nick_name like CONCAT('%', #{keyword},'%')
            or su.phone like CONCAT('%', #{keyword},'%'))
        </if>
    </select>

    <select id="queryUsersByCondition" resultType="org.macula.cloud.admin.entity.pojo.admin.SysUser">
        SELECT
        su.id,
        su.full_name,
        su.user_name,
        su.nick_name,
        sc.name AS companyName,
        sd.name AS departmentName
        FROM sys_user su

        INNER JOIN sys_user_role sur ON su.id = sur.user_id

        INNER JOIN sys_role sr ON sr.id = sur.role_id

        LEFT JOIN sys_department sd ON sd.business_id = su.department_id

        LEFT JOIN sys_company sc ON su.company_id = sc.business_id

        WHERE 1=1

        AND su.is_deleted = 0

        <if test="condition.roleId != null and condition.roleId !='' ">
            AND sur.role_id = #{condition.roleId}
        </if>

        <if test="condition.departmentId != null">
            AND su.department_id in
            (select d.id from dep_topology d,(
              select * from dep_topology d where d.id = #{condition.departmentId}) d1
            where
              case d1.level
                when 1 then d.level1id=d1.id
                when 2 then d.level2id=d1.id
                when 3 then d.level3id=d1.id
                when 4 then d.level4id=d1.id
                when 5 then d.level5id=d1.id
                when 6 then d.level6id=d1.id
            end)
        </if>

        <if test="condition.companyId != null">
            AND su.company_id=#{condition.companyId}
        </if>

        <if test="condition.userId != null and condition.createBy != null ">
            AND su.id=#{condition.userId} or su.create_by=#{condition.createBy}
        </if>

    </select>

    <select id="queryById" resultMap="resultUserMap">
		SELECT
		su.id,
		su.user_name ,
		su.full_name,
		su.nick_name,
		su.code,
		su.sex,
		su.birthday,
		su.company_id,
		su.grade,
		su.position,
		su.phone,
		su.mail,
		su.is_enabled,
		su.comments,
		su.id_card,
		getParentList(su.department_id,0) AS department_id_str,
		sr.id AS role_id
		FROM sys_user su
        LEFT JOIN sys_user_role  sur ON su.id = sur.user_id
        LEFT JOIN sys_role sr ON sr.id = sur.role_id
        WHERE su.id = #{id} AND su.is_deleted = 0
	</select>

    <select id="getUserByUsernameAndSource" resultMap="resultVoMap1">
        SELECT
        su.*,
        sd.name AS department_name,
        sc.short_name AS company_name
        FROM sys_user su
        LEFT JOIN sys_department sd ON sd.business_id = su.department_id
        LEFT JOIN sys_company sc ON sc.business_id = su.company_id
        WHERE su.user_name = #{user.userName}
        AND su.source = #{user.source}
        AND su.is_deleted = 0
    </select>
</mapper>
